<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="text/html; charset=UTF-8" http-equiv="content-type" />
<title>Custom game balancer (Overwatch)</title>
<meta name="description" content="Overwatch custom game balancer">
<style>

html {
	height: 100%;
}

body {
	margin: 1em;
	height: 95%;
}

.page-title {
	font-size: 26pt;
	display: inline-block;
	padding-bottom: 0.5em;
}

.copyright {
	float: right;
	display: inline;
}

.team-title {
	font-size: 20pt;
}

.table {
    display: table;
	max-height: 100%;
	
}

.row {
    display: table-row;
}

.cell {
	display: table-cell;
}

.teams {
	border-collapse: separate;
	border-spacing: 10px 5px;
}

.team {
	border: 1px solid black;
	background-color: lightgray;
	border-collapse: separate;
	border-spacing: 5px 5px;
	min-width: 15em;
}

.player-item {
	/* -- causing pushdown bug on class icons */
	/*border: 1px solid white; */
	background-color: white;
	cursor: default;
}

.player-icon {
	display: inline-block;
	/*padding-left: 5px;
	padding-right: 5px;*/
	text-align: center;
	vertical-align: middle;
	line-height: 80%;
}

.icon-image {
	display: inline;
}

.rank-icon {
	width: 24px;
}

.icon-sr {
	display: inline;
	font-size: 8pt;
}

.player-name {
	display: inline;
	font-size: 16pt;
}

.player-selected {
	background-color: blue;
	color: white;
}

.team-selecor {
	margin-left: 1em;
}

.team_btn {
	float: right;
	font-size: 70%;
}

.lobby-container {
	position: relative;
	top: 0;
	bottom: 0;
	overflow-y: auto;
	max-height: 33em;
	padding-right: 1.2em;
	overflow-x: hidden;
}

.trashcan {
    display: inline-block;
    border: 1px dashed black;
    /*background-color: lightgray;*/
    vertical-align: middle;
    width: 100%;
	line-height: 2em;
	text-align: center;
	font-size: 16pt;
}

.big-btn {
	font-size: 16pt;
	line-height: 2em;
	vertical-align: middle;
}

.team-toolbar {
	display: inline-block;
	width: 100%;
}

.sr-edit {
	padding: 0;
	font-size: 8pt;
}

.tips {
	background-color: lightgreen;
	border-radius: 1em;
	padding: 1em;
	margin-left: 5em;
	max-width: 20em;
	min-width: 15em;
}

li {
	margin-bottom: 1em;
}

.class-icon {
	height: 1.2em;
	float: right;
	filter: opacity(60%);
}

.secondary-class {
	height: 0.9em;
	filter: opacity(40%);
}

.dlg {
	position: fixed;
	left: 0px;
	top: 0px;
	width: 100%;
	height: 100%;
	text-align: center;
	vertical-align: middle;
}

.dlg-content {
	position: absolute;
	left: 35%;
	top: 35%;
	width: 30%;
	height: 30%;
	/*margin-top: -5em;*/
	z-index: 20;
	background-color: white;
	border: 1px solid black;
	padding: 2em;
	padding-top: 0.5em;
	box-shadow: 3px 3px 7px gray;
}

textarea {
	text-align: left;
}

.filter {
	border: 1px solid;
	margin-bottom: 5px;
}

.filter-active {
	/*border-color: blue;*/
	outline: none;
	box-shadow: 0 0 10px #9ecaed;
}

</style>

<script language="JavaScript" type="text/javascript">
var selected_player_team1 = "";
var selected_player_team2 = "";
var team1 = [];
var team2 = [];
var lobby = [];
var team_size = 6;
var region = "eu";
var current_player_edit = "";
var min_api_request_interval = 5000; //milliseconds

// global variables for recursive team balancer
var balance_team_combinations = [];
var current_team_combination = [];
var active_players = [];
var active_players_total_sr = 0;
var best_sr_diff = 0;
var best_sr_diff_index = 0;

// hero list for calculating main classes
var hero_classes = {
	reaper:		"offence",
	pharah:		"offence",
	soldier76:	"offence",
	genji:		"offence",
	tracer:		"offence",
	sombra:		"offence",
	mccree:		"offence",
	
	torbjorn:	"defence",
	hanzo:		"defence",
	mei:		"defence",
	bastion:	"defence",
	widowmaker:	"defence",
	junkrat:	"defence",
	
	mercy:		"support",
	ana:		"support",
	lucio:		"support",
	zenyatta:	"support",
	symmetra:	"support",
	
	dva:		"tank",
	orisa:		"tank",
	winston:	"tank",
	zarya:		"tank",
	roadhog:	"tank",
	reinhardt:	"tank",
};

var players_for_update = [];

function player_item_onclick(item, team_id) {
	if ( item.id != current_player_edit ) {
		cancel_player_edit();
	}

	var prev_selected_id = "";
	if (team_id == "team1") {
		prev_selected_id = selected_player_team1;
		selected_player_team1 = "";
	} else if (team_id == "team2") {
		prev_selected_id = selected_player_team2;
		selected_player_team2 = "";
	} else {
		return;
	}

	if (prev_selected_id != "" ) {
		var prev_selected = document.getElementById(prev_selected_id);
		prev_selected.classList.toggle("player-selected");
	}

	if (prev_selected_id != item.id) {
		if (item.id != "") {
			item.classList.toggle("player-selected");
		}
	
		if (team_id == "team1") {
			selected_player_team1 = item.id;
		} else {
			selected_player_team2 = item.id;
		}
	}
	
	if (selected_player_team1!="" && selected_player_team2!="") {
		document.getElementById("swap_btn").disabled = false;
	} else {
		document.getElementById("swap_btn").disabled = true;
	}
	
}

function player_drag(ev) {
	 ev.dataTransfer.setData("text/plain", ev.currentTarget.id);
}

function player_allowDrop(ev) {
    ev.preventDefault();
}

function player_drop(ev) {
    ev.preventDefault();
	ev.stopPropagation();
	
    var dragged_id = ev.dataTransfer.getData("text");
	var target_id = ev.currentTarget.id;
	if (dragged_id == target_id) {
		return false;
	}
	
	var drag_action = "swap";
	
	if( target_id == "trashcan" ) {
		drag_action = "remove";
		target_id = "";
	}
	
	// find team and index in team for both players 
	var dragged_team;
	var dragged_index;
	var dragged_player;
	var target_team;
	var target_index;
	var target_player;
	
	for( var i=0; i<team1.length; i++) {
		if ( dragged_id == team1[i].id) {
			dragged_team = team1;
			dragged_index = i;
			dragged_player = team1[i];
		}
		if ( target_id == team1[i].id) {
			target_team = team1;
			target_index = i;
			target_player = team1[i];
		}
	}
	for( var i=0; i<team2.length; i++) {
		if ( dragged_id == team2[i].id) {
			dragged_team = team2;
			dragged_index = i;
			dragged_player = team2[i];
		}
		if ( target_id == team2[i].id) {
			target_team = team2;
			target_index = i;
			target_player = team2[i];
		}
	}
	for( var i=0; i<lobby.length; i++) {
		if ( dragged_id == lobby[i].id) {
			dragged_team = lobby;
			dragged_index = i;
			dragged_player = lobby[i];
		}
		if ( target_id == lobby[i].id) {
			target_team = lobby;
			target_index = i;
			target_player = lobby[i];
		}
	}
	
	// dropped on empty slot
	if (target_id == "") {
		var parent_id = ev.currentTarget.parentElement.parentElement.id;
		if (parent_id == "lobby") {
			target_team = lobby;
			target_index = lobby.length;
		} else if (parent_id == "team1") {
			target_team = team1;
			target_index = team1.length;
		} else {
			target_team = team2;
			target_index = team2.length;
		}
	}
	
	if ((target_team == lobby) && (dragged_team != lobby)) {
		drag_action = "move"; 
	}
	
	if (drag_action == "move") {
		// move dragged player to target team (lobby)
		target_team.splice(target_index, 0, dragged_player);
		dragged_team.splice(dragged_index, 1);
	} else {
		if (target_id == "") {
			//team2.splice(dragged_index,1);
			// remove dragged player from source team
			dragged_team.splice(dragged_index, 1);
		} else {
			// replace dragged player with target
			dragged_team[dragged_index] = target_player;
		}
	}
	
	if (drag_action == "swap") {
		// replace target with dragged player
		target_team[target_index] = dragged_player;
	}
	
	redraw_teams();
}

function player_dblClick(ev) {
	var selected_id = ev.currentTarget.id;
	
	if (selected_id == "") {
		return;
	}

	// detect selected team
	var selected_team;
	var parent_id = ev.currentTarget.parentElement.parentElement.id;
	if (parent_id == "lobby") {
		selected_team = lobby;
	} else if (parent_id == "team1") {
		selected_team = team1;
	} else {
		selected_team = team2;
	}
	
	// find index in team for player
	var selected_index;
	var selected_player;
	for( var i=0; i<selected_team.length; i++) {
		if ( selected_id == selected_team[i].id) {
			selected_index = i;
			selected_player = selected_team[i];
		}
	}
	
	// detect target team
	var new_team;
	if (selected_team == lobby) {
		if (team1.length < team_size) {
			new_team = team1;
		} else {
			new_team = team2;
		}
	} else {
		new_team = lobby;
	}
	
	// move player
	new_team.push( selected_player );
	selected_team.splice(selected_index, 1);
	
	// clear selection
	selected_player_team1 = "";
	selected_player_team2 = "";
	
	redraw_teams();
}

function draw_player( player_struct, team_id ) {
	var text_node;
	var br_node;
	
	var team_list = document.getElementById(team_id);
	
	var new_player_item_row = document.createElement("div");
	new_player_item_row.className = "row ";
	
	var new_player_item = document.createElement("div");
	new_player_item.className = "cell player-item";
	new_player_item.id = player_struct.id;
	new_player_item.title = player_struct.id;
	new_player_item.onclick = function(){player_item_onclick(this, team_id);};
	if( ! player_struct.empty) {
		new_player_item.draggable = true;
	}
	new_player_item.ondragstart = function(event){player_drag(event);};
	new_player_item.ondrop = function(event){player_drop(event);};
	new_player_item.ondragover = function(event){player_allowDrop(event);};
	new_player_item.ondblclick = function(event){player_dblClick(event);};
	new_player_item_row.appendChild(new_player_item);
	
	// rank icon and SR
	var player_icon = document.createElement("div");
	player_icon.className = "player-icon";
	
	var icon_image = document.createElement("div");
	icon_image.className = "icon-image";
	
	var img_node = document.createElement("img");
	img_node.className = "rank-icon";
	var rank_name = get_rank_name(player_struct.sr);
	img_node.src = "rank_icons/"+rank_name+"_small.png";
	img_node.title = rank_name;
	icon_image.appendChild(img_node);
	player_icon.appendChild(icon_image);
	
	br_node = document.createElement("br");
	player_icon.appendChild(br_node);
	
	var icon_sr = document.createElement("div");
	icon_sr.className = "icon-sr";
	icon_sr.oncontextmenu = function(event){player_sr_click(event);};
	
	var sr_display = document.createElement("span");
	sr_display.id = "sr_display_"+player_struct.id;
	var sr_text = player_struct.sr;
	if( player_struct.empty ) {
		sr_text = '\u00A0';
	}
	text_node = document.createTextNode( sr_text );
	sr_display.appendChild(text_node);
	sr_display.appendChild(text_node);
	icon_sr.appendChild(sr_display);
	
	var sr_input = document.createElement("input");
	sr_input.type = "text";
	sr_input.className = "inline-edit sr-edit";
	sr_input.style = "display:none";
	sr_input.name = player_struct.id;
	sr_input.id = "sr_edit_"+player_struct.id;
	sr_input.value = player_struct.sr;
	sr_input.size = 4;
	sr_input.onchange = function(event){player_sr_change(event);};
	icon_sr.appendChild(sr_input);
	
	
	player_icon.appendChild(icon_sr);
	
	new_player_item.appendChild(player_icon);
	
	// space after rank icon
	text_node = document.createTextNode("\u00A0");
	new_player_item.appendChild(text_node)
	
	// player name
	var player_name = document.createElement("div");
	player_name.className = "player-name";
	player_name.oncontextmenu = function(event){player_name_click(event);};
	
	var name_display = document.createElement("span");
	name_display.id = "name_display_"+player_struct.id;
	text_node = document.createTextNode(player_struct.display_name);
	name_display.appendChild(text_node);
	player_name.appendChild(name_display);
	
	var name_input = document.createElement("input");
	name_input.type = "text";
	name_input.className = "inline-edit";
	name_input.style = "display:none";
	name_input.name = player_struct.id;
	name_input.id = "name_edit_"+player_struct.id;
	name_input.value = player_struct.display_name;
	name_input.onchange = function(event){player_name_change(event);};
	player_name.appendChild(name_input);
	
	new_player_item.appendChild(player_name);
	
	// class icons
	if ( player_struct.top_classes !== undefined ) {
		//for(var i=player_struct.top_classes.length-1; i>=0; i--) {
		for(var i=0; i<player_struct.top_classes.length; i++) {
			var class_icon = document.createElement("img");
			class_icon.className = "class-icon";
			if( i != 0 )  {
				class_icon.className += " secondary-class";
			}
			class_icon.src = "class_icons/"+player_struct.top_classes[i]+".png";
			class_icon.title = player_struct.top_classes[i];
			new_player_item.appendChild(class_icon);
		}
	}
	
	team_list.appendChild(new_player_item_row);
}

function redraw_teams() {
	document.getElementById("team1").innerHTML = "";
	document.getElementById("team2").innerHTML = "";
	document.getElementById("lobby").innerHTML = "";

	for( var i=0; i<team1.length; i++) {
		draw_player( team1[i], "team1" );
	}
	// add empty players up to max team size
	for( i=team1.length; i<team_size; i++) {
		draw_player(  create_empty_player(), "team1" );
	}

	for( var i=0; i<team2.length; i++) {
		draw_player( team2[i], "team2" );
	}
	for( i=team2.length; i<team_size; i++) {
		draw_player( create_empty_player(), "team2" );
	}
	
	for( var i=0; i<lobby.length; i++) {
		draw_player( lobby[i], "lobby" );
	}
	for( i=lobby.length; i<team_size; i++) {
		draw_player( create_empty_player(), "lobby" );
	}
	
	document.getElementById("lobby_count").innerHTML = lobby.length;
		
	update_teams_sr();
	
	save_players_list();
}

function save_players_list() {
	// store players to browser local storage
	var all_players = lobby.concat(team1).concat(team2);
	localStorage.setItem("saved_players", JSON.stringify(all_players));
}

function swap_players() {
	var player1;
	var player1_index;
	for( var i=0; i<team1.length; i++) {
		if (team1[i].id == selected_player_team1) {
			player1 = team1[i];
			player1_index = i;
			break;
		}
	}
	var player2;
	var player2_index;
	for( var i=0; i<team2.length; i++) {
		if (team2[i].id == selected_player_team2) {
			player2 = team2[i];
			player2_index = i;
			break;
		}
	}
	
	team1[player1_index] = player2;
	team2[player2_index] = player1;
	
	selected_player_team1 = "";
	selected_player_team2 = "";
	
	redraw_teams();
	
	document.getElementById("swap_btn").disabled = true;
}

function calculate_team_sr( team ) {
	var team_sr = 0;
	if (team.length > 0) {
		for( var i=0; i<team.length; i++) {
			team_sr = team_sr + team[i].sr;
		}
		team_sr = Math.round(team_sr / team.length);
	}
	return team_sr;
}

function update_teams_sr() {
	document.getElementById("team1_sr").innerHTML = calculate_team_sr(team1);
	document.getElementById("team2_sr").innerHTML = calculate_team_sr(team2);
}

function get_rank_name( sr ) {
	if (sr == 0) {
		return "unranked"
	} else if ( sr < 1500) {
		return "bronze";
	} else if ( sr < 2000 ) {
		return "silver";
	} else if ( sr < 2500 ) {
		return "gold";
	} else if ( sr < 3000 ) {
		return "platinum";
	} else if ( sr < 3500 ) {
		return "diamond";
	} else if ( sr < 4000 ) {
		return "master";
	} else if ( sr < 5000 ) {
		return "grandmaster";
	} else {
		return "unranked";
	}
}

function add_player_click() {
	var player_id = document.getElementById("new_player_id").value;
	player_id = player_id.trim().replace("#", "-");
	player_name = player_id.slice( 0, player_id.search("-") );
	
	// check duplicates
	for( var i=0; i<team1.length; i++) {
		if( team1[i].id == player_id) {
			alert("Player already added");
			return;
		}
	}
	for( var i=0; i<team2.length; i++) {
		if( team2[i].id == player_id) {
			alert("Player already added");
			return;
		}
	}
	for( var i=0; i<lobby.length; i++) {
		if( lobby[i].id == player_id) {
			alert("Player already added");
			return;
		}
	}
	
	// determine team to add new player
	var new_player_team;
	var team_selectors = document.getElementsByName("add_team_select");
    for (var i=0; i<team_selectors.length; i++) {
        if (team_selectors[i].checked) {
			if (team_selectors[i].value == "team1") {
				new_player_team = team1;
			} else if (team_selectors[i].value == "team2") {
				new_player_team = team2;
			} else if (team_selectors[i].value == "lobby") {
				new_player_team = lobby;
			} else { // auto team
				if (team1.length < team_size) {
					new_player_team = team1;
				} else {
					new_player_team = team2;
				}
			}
		}
	}
	
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 ) {
			if ( this.status == 200) {
				var stats_obj = JSON.parse(this.responseText);
				if ( stats_obj[region] !== null ) {	
					var top_classes = calculate_top_classes( stats_obj[region].heroes.playtime.competitive );
					
					var new_player = {
						id: player_id,
						display_name: player_name, 
						sr: stats_obj[region].stats.competitive.overall_stats.comprank,
						level: stats_obj[region].stats.competitive.overall_stats.prestige*100 + stats_obj[region].stats.competitive.overall_stats.level,
						top_classes: top_classes,
					};
					new_player_team.push(new_player);
					
					document.getElementById("new_player_id").value = "";
					
					redraw_teams();
				} else {
					alert("Player has no stats in region "+region.toUpperCase());
				}
			} else {
				alert("Can't get player stats ("+this.status+"), connection problem or incorrect BattleTag");
			}
		}
		document.getElementById("add_btn").disabled = false;
		document.getElementById("add_btn").innerHTML = "add player";
	};
	xhttp.open("GET", "https://owapi.net/api/v3/u/"+player_id+"/blob", true);
	document.getElementById("add_btn").disabled = true;
	document.getElementById("add_btn").innerHTML = "processing...";
	xhttp.send();
}

function sort_team( team, sort_field = 'sr' ) {
	team.sort( function(player1, player2){
			if( typeof player1[sort_field] === 'string') {
				var val1 = player1[sort_field].toLowerCase();
				var val2 = player2[sort_field].toLowerCase();
				return ( val1<val2 ? -1 : (val1>val2?1:0) );
			} else {
				return player2[sort_field] - player1[sort_field];
			}
		} );
}

function clear_team( team ) {
	if( confirm("Clear team?") ) {
		team.splice( 0, team.length );
	}
}

function create_empty_player() {
	return {
			id: "",
			display_name: "",
			sr: 0,
			empty: true
		};
}
function create_random_player( id ) {
	return {
			id: "player"+id+"#1234",
			display_name: "player"+id,
			sr: Math.round(Math.random()*5000),
			empty: false
		};
}

function move_team_to_lobby(team) {
	lobby = lobby.concat(team);
	team.splice( 0, team.length );
}

function fill_test_teams() {
	// fill teams with ramdom players
	team1.splice( 0, team1.length );
	team2.splice( 0, team2.length );
	lobby.splice( 0, lobby.length );
	
	var new_player;
	for( var i=1; i<=team_size; i++ ) {
		new_player = create_random_player(i);
		team1.push( new_player );
	}

	for( var i=team_size+1; i<=team_size*2; i++ ) {
		new_player = create_random_player(i);
		team2.push( new_player );
	}

	for( var i=team_size*2+1; i<=team_size*3; i++ ) {
		new_player = create_random_player(i);
		lobby.push( new_player );
	}

	redraw_teams();
}

function generate_team_combination(num, last) {
	if (num == team_size) {
		// composition is ready, store to list
		var new_composition_players = current_team_combination.slice();
		var composition_sr = calculate_team_sr(new_composition_players);
		var sr_diff = Math.abs(2*composition_sr*team_size - active_players_total_sr);
		var new_composition = {
			sr: composition_sr,
			sr_diff: sr_diff,
			players: new_composition_players,
		};
		balance_team_combinations.push( new_composition );
		
		if( sr_diff < best_sr_diff ) {
			best_sr_diff = sr_diff;
			best_sr_diff_index = balance_team_combinations.length-1;
		}
	}
	
	for (var i=last; i<active_players.length; i++) {
			current_team_combination.push( active_players[i] );
			generate_team_combination(num+1, i+1);
			current_team_combination.pop();
	}
}

function balance_teams() {
	active_players = team1.concat(team2);
	team1.splice( 0, team1.length );
	team2.splice( 0, team2.length );
	
	sort_team( active_players );
	
	active_players_total_sr = 0;
	for (var i=0; i<active_players.length; i++ ) {
		active_players_total_sr = active_players_total_sr + active_players[i].sr;
	}
	best_sr_diff = active_players_total_sr;
	
	current_team_combination.splice( 0, current_team_combination.length );
	balance_team_combinations.splice( 0, balance_team_combinations.length );
	
	generate_team_combination(0, 0);
	
	team1 = balance_team_combinations[best_sr_diff_index].players.slice();
	for (var i=0; i<active_players.length; i++ ) {
		if( team1.indexOf(active_players[i]) == -1 ) {
			team2.push(active_players[i]);
		}
	}
	
	sort_team( team1 );
	sort_team( team2 );
	
	redraw_teams();
	
	
	// debug
	//alert( balance_team_combinations.length );
	/*var res = "";
	for (var i=0; i<balance_team_combinations.length; i++ ) {
		res = res + i + " : ";
		for (var p=0; p<balance_team_combinations[i].players.length; p++) {
			res = res + balance_team_combinations[i].players[p].display_name + " ";
		}
		res = res + " = " + balance_team_combinations[i].sr_diff + "<br/>";
		
	}
	res = res +  "best : " + best_sr_diff_index;
	document.getElementById("test_result").innerHTML = res;*/
}	

function update_team_size( new_value ) {
	team_size = Number(new_value);
	redraw_teams();
	localStorage.setItem("team_size", team_size);
}

function update_region( new_value ) {
	region = new_value;
	localStorage.setItem("region", region);
}

function find_player_by_id(player_id) {
	for( var i=0; i<team1.length; i++) {
		if ( player_id == team1[i].id) {
			return team1[i];
		}
	}
	for( var i=0; i<team2.length; i++) {
		if ( player_id == team2[i].id) {
			return team2[i];
		}
	}
	for( var i=0; i<lobby.length; i++) {
		if ( player_id == lobby[i].id) {
			return lobby[i];
		}
	}
	return undefined;
}

function player_name_click(ev) {
	cancel_player_edit();
	if ( ev.button == 2) {
		// edit player name
		ev.preventDefault();
		
		cancel_player_edit();
		
		var player_id = ev.currentTarget.parentElement.id;
		var input = document.getElementById("name_edit_"+player_id);
		input.style.display = "inline";
		
		var display = document.getElementById("name_display_"+player_id);
		display.style.display = "none";
		
		current_player_edit = player_id;
		
		return false;
	}
}

function player_name_change(ev) {
	var player_id = ev.currentTarget.parentElement.parentElement.id;
	var input = document.getElementById("name_edit_"+player_id);
	input.style.display = "none";
	
	var display = document.getElementById("name_display_"+player_id);
	display.style.display = "inline";
	display.innerHTML = input.value;
	
	var player_struct = find_player_by_id(player_id);
	player_struct.display_name = input.value;
	
	save_players_list();
}

function player_sr_click(ev) {
	if ( ev.button == 2) {
		// edit player name
		ev.preventDefault();
		
		cancel_player_edit();
		
		var player_id = ev.currentTarget.parentElement.parentElement.id;
		
		var input = document.getElementById("sr_edit_"+player_id);
		input.style.display = "inline";
		
		var display = document.getElementById("sr_display_"+player_id);
		display.style.display = "none";
		
		current_player_edit = player_id;
		
		// disable context menu
		return false;
	}
}

function player_sr_change(ev) {
	var player_id = ev.currentTarget.parentElement.parentElement.parentElement.id;
	var input = document.getElementById("sr_edit_"+player_id);
	input.style.display = "none";
	
	var display = document.getElementById("sr_display_"+player_id);
	display.style.display = "inline";
	display.innerHTML = input.value;
	
	var player_struct = find_player_by_id(player_id);
	player_struct.sr = Number(input.value);
	
	save_players_list();
}

function cancel_player_edit() {
	if (current_player_edit == "") {
		return;
	}
	var player_struct = find_player_by_id(current_player_edit);

	var input = document.getElementById("sr_edit_"+current_player_edit);
	input.value = player_struct.sr;
	input.style.display = "none";
	
	var display = document.getElementById("sr_display_"+current_player_edit);
	display.style.display = "inline";
	
	input = document.getElementById("name_edit_"+current_player_edit);
	input.value = player_struct.display_name;
	input.style.display = "none";
	
	var display = document.getElementById("name_display_"+current_player_edit);
	display.style.display = "inline";
	
	current_player_edit = "";
}

function export_lobby() {
	var export_struct = {
		format_version: 1,
		players: lobby
		};
	var export_str = JSON.stringify(export_struct);
	
	//alert(export_str);
	document.getElementById("popup_dlg").style.display = "block";
	document.getElementById("dlg_title").innerHTML = "";
	document.getElementById("dlg_textarea").value = export_str;
	document.getElementById("dlg_textarea").style.display = "inline";
	document.getElementById("dlg_textarea").select();
	document.getElementById("dlg_textarea").focus();
	
	document.getElementById("dlg_ok").onclick = function(event){close_dialog();};
}

function import_lobby() {
	var import_str = prompt("Enter import string");

	if (import_str !== null && import_str != "") {
		try {
			// try to parse json
			var import_struct = JSON.parse(import_str);
			
			for( var i=0; i<import_struct.players.length; i++) {
				// check duplicates
				if (find_player_by_id(import_struct.players[i].id) === undefined ) {
					lobby.splice(lobby.length, 0, import_struct.players[i]);
				}
			}
			
			redraw_teams();
		}
		catch(err) {
			// try to parse as plain battletag list
			alert("Incorrect import format");
		}
	}
}

// returns top 2 hero classes
function calculate_top_classes( hero_playtime ) {
	var class_playtime = {
		offence: 0,
		defence: 0,
		tank: 0,
		support: 0
		};
	
	var total_playtime = 0;
	for (var hero_name in hero_playtime ) {
		var hero_class = hero_classes[hero_name];
		class_playtime[hero_class] += hero_playtime[hero_name];
		total_playtime += hero_playtime[hero_name];
	}
	
	var class_playtime_arr = Object.entries(class_playtime);
	class_playtime_arr.sort( function(item1, item2){
			return item2[1]-item1[1];
		});
	
	var top_classes = [];
	var top_class = class_playtime_arr.shift();
	if( top_class !== undefined ) {
		top_classes.push( top_class[0] );
	}
	top_class = class_playtime_arr.shift();
	if( top_class !== undefined ) {
		if( Number(top_class[1])/total_playtime >= 0.25 ) {
			top_classes.push( top_class[0] );
		}
	}
	
	return top_classes;
}

function update_next_player_stats( ) {
	if ( players_for_update.length > 0 ) {
		var current_player = players_for_update[0];
		var xhttp = new XMLHttpRequest();
		
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 ) {
				var player =  players_for_update.shift();
				var cancel_update = false;
				
				if ( this.status == 200) {
					var stats_obj = JSON.parse(this.responseText);
					if ( stats_obj[region] !== null ) {
						var top_classes = calculate_top_classes( stats_obj[region].heroes.playtime.competitive );
						
						player.sr = stats_obj[region].stats.competitive.overall_stats.comprank;
						player.level = stats_obj[region].stats.competitive.overall_stats.prestige*100 + stats_obj[region].stats.competitive.overall_stats.level;
						player.top_classes = top_classes;
					} else {
						if( ! confirm( "Player "+player.id+" has no stats in region "+region.toUpperCase()+". Continue updating stats?" ) ) {
							cancel_update = true;
						}
					}
				}
				
				if( cancel_update) {
					document.getElementById("update_stats_btn").disabled = false;
					document.getElementById("update_stats_btn").value = "Update stats";
					redraw_teams();
				} else {
					setTimeout( update_next_player_stats, min_api_request_interval );
				}
			}
		};
		
		xhttp.open("GET", "https://owapi.net/api/v3/u/"+current_player.id+"/blob", true);
		xhttp.send();
	} else {
		// all players updated
		alert("All stats updated");
		document.getElementById("update_stats_btn").disabled = false;
		document.getElementById("update_stats_btn").value = "Update stats";
		redraw_teams();
	}
}

function update_all_stats() {
	players_for_update.splice( 0, players_for_update.length );
	players_for_update = lobby.concat(team1).concat(team2);
	
	var time_needed = Math.round( (min_api_request_interval+2000)*players_for_update.length / 1000 );
	alert("Updating all players stats will take about "+time_needed+" seconds due to request interval restrictions.");

	document.getElementById("update_stats_btn").disabled = true;
	document.getElementById("update_stats_btn").value = "Updating stats...";
	
	update_next_player_stats();
}

function close_dialog() {
	document.getElementById("popup_dlg").style.display = "none";
}

function lobby_filter_change() {
	var filter_value = document.getElementById("lobby_filter").value.toLowerCase();
	if (filter_value != "") {
		document.getElementById("lobby_filter").classList.add("filter-active");
	} else {
		document.getElementById("lobby_filter").classList.remove("filter-active");
	}
	
	for( var i=0; i<lobby.length; i++) {
		if ( filter_value == "" || lobby[i].display_name.toLowerCase().includes( filter_value ) ) {
			document.getElementById(lobby[i].id).parentElement.style.display = "table-row";
		} else {
			document.getElementById(lobby[i].id).parentElement.style.display = "none";
		}
	}
}

</script>
</head>
<body >

<div class="page-title">Overwatch custom game balancer</div>
<div class="copyright">© 2017 l33t m3at</div>
<br/>


Team size <input id="team_size" name="team_size" type="number" size=3 min=1 max=12 style="width: 3em;" value="" onchange="update_team_size(this.value);"/> players. 
Region 
<select id="region" onchange="update_region(this.value);">
	<option value="eu">EU</option>
	<option value="us">US</option>
	<option value="kr">KR</option>
</select> 
<br/>
<br/>


<input id="new_player_id" name="new_player_id" type="text" size=35 placeholder="PlayerName#1234 or PlayerName-1234" value="" onchange="add_player_click();"/> 
<button onclick="add_player_click();" id="add_btn" >add player</button> to 
<input class="team-selecor" type="radio" name="add_team_select" value="lobby" >lobby
<input class="team-selecor" type="radio" name="add_team_select" value="team_1" >team 1 
<input class="team-selecor" type="radio" name="add_team_select" value="team_2" >team 2 
<input class="team-selecor" type="radio" name="add_team_select" value="team_auto" checked>auto team

<br/>
<br/>

<div class="table teams">
	<div class="row">
		<div class="cell">
			<div class="team-toolbar">
			<input title="Clear lobby" type="button" class="team_btn" onclick="clear_team(lobby);redraw_teams();" value=" X "/>
			<input title="Import lobby" type="button" class="team_btn" onclick="import_lobby();" value="Im"/>
			<input title="Export lobby" type="button" class="team_btn" onclick="export_lobby();" value="Ex"/>
			<input title="Sort lobby by SR" type="button" class="team_btn" onclick="sort_team(lobby, 'sr');redraw_teams();" value="&uarr;&darr;#"/>
			<input title="Sort lobby by name" type="button" class="team_btn" onclick="sort_team(lobby, 'display_name');redraw_teams();" value="&uarr;&darr;Az"/>
			</div>
		
			<div>
			<span class="team-title">Lobby</span>
			</div>
			
			<span id="lobby_count">0</span> players<br/>
			
			<input id="lobby_filter" class="filter" type="text" size=35 autocomplete="off" placeholder="filter by nickname" value="" oninput="lobby_filter_change();"/> 
			
			<div class="lobby-container">
				<div class="table team" id="lobby">

				</div>
			</div>
			
			<br/>
			<div title="Drop player here to delete" class="trashcan" id="trashcan" ondrop="player_drop(event)" ondragover="player_allowDrop(event)">				
				&#9760; Delete player (drop here)
			</div>
		</div>
		
		
		<div class="cell" style="width: 15em">
		<!-- spacer -->
		</div>
	
		<div class="cell">
			<div class="team-toolbar">
			<input title="Clear team" type="button" class="team_btn" onclick="clear_team(team1);redraw_teams();" value=" X "/>
			<input title="Sort team by SR" type="button" class="team_btn" onclick="sort_team(team1, 'sr');redraw_teams();" value="&uarr;&darr;#"/>
			<input title="Sort team by name" type="button" class="team_btn" onclick="sort_team(team1, 'display_name');redraw_teams();" value="&uarr;&darr;Az"/>
			<input title="Move all players to lobby" type="button" class="team_btn" onclick="move_team_to_lobby(team1);redraw_teams();" value="&lt;&lt;"/>
			</div>
			
			<div>
			<span class="team-title" contenteditable="true">Team 1</span>
			</div>
			
			<span id="team1_sr">0</span> average SR<br/>
			
			<div class="table team" id="team1">
				<!-- team 1 players -->
			</div>
			
			<br/>
			<div >
			<input class="big-btn" type="button" id="balance_btn" onclick="balance_teams();" value="&#9878; Balance teams"/>
			<br/>
			<br/>
			<input class="big-btn" type="button" id="update_stats_btn" onclick="update_all_stats();" value="Update stats"/>
			
			<br/>
			<br/>
			<input class="big-btn" style="display:none" type="button" onclick="fill_test_teams();" value="Test"/>
			</div>
		</div>
		
		<div class="cell" style="vertical-align: top; padding-top: 10em; min-width: 5em; text-align: center;">
		<input type="button" title="Swap selected players" id="swap_btn" disabled="true" onclick="swap_players();" value="&larr;&rarr;"/>
		</div>
		
		<div class="cell">
			<div class="team-toolbar">
			<input title="Clear team" type="button" class="team_btn" onclick="clear_team(team2);redraw_teams();" value=" X "/>
			<input title="Sort team by SR" type="button" class="team_btn" onclick="sort_team(team2, 'sr');redraw_teams();" value="&uarr;&darr;#"/>
			<input title="Sort team by name" type="button" class="team_btn" onclick="sort_team(team2, 'display_name');redraw_teams();" value="&uarr;&darr;Az"/>
			<input title="Move all players to lobby" type="button" class="team_btn" onclick="move_team_to_lobby(team2);redraw_teams();" value="&lt;&lt;"/>
			</div>
			
			<div>
			<span class="team-title" contenteditable="true">Team 2</span>
			</div>
		
			<span id="team2_sr">0</span> average SR<br/>
			
			<div class="table team" id="team2">
				<!-- team 2 players -->
			</div>
		</div>
		
		<div class="cell">
			<div class="tips">
				<span class="team-title">&#x2753; Info</span>
				<br>
				<ul>
					<li>Add players by full BattleTag</li>
					<li>Drag & drop players between teams</li>
					<li>Right click on player name or SR to edit</li>
					<li>Team names are editable</li>
					<li>Player list automatically saved in your browser's storage</li>
					<li>Click 'Balance teams' to automatically swap players between teams for minimum team SR difference</li>
				</ul> 
			</div>
		</div>
	</div>
	

</div>

<div id="popup_dlg" class="dlg" style="display:none">
	<div class="dlg-content">
		<span id="dlg_title" class="team-title">Title</span>
		<input title="Close" type="button" class="team_btn dlg-close" onclick="close_dialog();" value="X"/>
		<br/>
		<br/>
		<textarea id="dlg_textarea" rows="10" cols="50"></textarea>
		<br/>
		<br/>
		<input id="dlg_ok" class="big-btn" type="button" value="OK"/>
	<div>
</div>

<div id="test_result"></div>

<script>
//restore saved players to lobby
var saved_players_json = localStorage.getItem("saved_players");
if ( saved_players_json != null ) {
	lobby = JSON.parse(saved_players_json);
	sort_team(lobby, 'display_name');
	
	// delete deprecated fields
	for (var i=0; i<lobby.length; i++) {
		delete lobby[i].current_sr;
		delete lobby[i].max_sr;
	}
}

var team_size_str = localStorage.getItem("team_size");
if ( team_size_str != null ) {
	team_size = Number(team_size_str);
}

document.getElementById("team_size").value = team_size;

var region_str = localStorage.getItem("region");
if ( region_str != null ) {
	region = region_str;
}

document.getElementById("region").value = region;

redraw_teams();

</script>

</body>
</html>
